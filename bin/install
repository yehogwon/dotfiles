#!/bin/bash

DF_INST_ROOT="$HOME/.dotfiles_bin"
if [ ! -d "$DF_INST_ROOT" ]; then
    mkdir -p "$DF_INST_ROOT"
fi

function neovim() {
    NVIM_INST_PATH="$DF_INST_ROOT/nvim"

    if [ -d "$NVIM_INST_PATH" ]; then
        echo -e "\e[1;31m$NVIM_INST_PATH already exists\e[0m"
        exit 1
    fi

    if [ "$(uname)" == "Darwin" ]; then
        if [ "$(uname -m)" == "arm64" ]; then
            suffix="macos-arm64"
        else
            suffix="macos-x86_64"
        fi
    elif [ "$(uname)" == "Linux" ]; then
        if [ "$(uname -m)" == "arm64" ]; then
            suffix="linux-arm64"
        else
            suffix="linux-x86_64"
        fi
    else
        echo -e "\e[1;31mUnsupported platform: $(uname) :: $(uname -m)\e[0m"
        exit 1
    fi

    _output_tmp="/tmp/.nvim.tar.gz.tmp"
    curl -L "https://github.com/neovim/neovim/releases/download/v0.11.0/nvim-$suffix.tar.gz" > $_output_tmp
    tar -C /tmp/ -xzf $_output_tmp
    rm $_output_tmp
    mv /tmp/nvim-$suffix $NVIM_INST_PATH

    echo -e "\e[1;33mInstalled neovim. Add the following to your \$PATH:\e[0m"
    echo -e "$NVIM_INST_PATH/bin"
    echo -e "alias vim='nvim'"
    echo -e "alias vi='nvim'"
    echo -e "\e[1;33mNote: This dotsync will do this on behalf of you!\e[0m"

    return 0
}

function git() {
    echo -e "\e[1;31mInstalling git is not supported yet.\e[0m"
    return 1
}

function tmux() {
    curl -s https://api.github.com/repos/nelsonenzo/tmux-appimage/releases/latest \
    | grep "browser_download_url.*appimage" \
    | cut -d : -f 2,3 \
    | tr -d \" \
    | wget -O ~/.__tmux.appimage -qi - \
    && chmod +x ~/.__tmux.appimage

    ## optionaly, move it into your $PATH
    mv tmux.appimage /usr/local/bin/tmux
    tmux
    return 1
}

packages=$@
# for each package, check if corresponding function exists
unknown_packages=()
for package in $packages; do
    if ! declare -f $package > /dev/null; then
        unknown_packages+=($package)
    fi
done

if [ ${#unknown_packages[@]} -gt 0 ]; then
    echo -e "\e[1;31mUnknown packages: ${unknown_packages[@]}\e[0m"
    exit 1
fi

for package in $packages; do
    case $package in
        neovim) neovim ;;
        git) git ;;
        tmux) tmux ;;
    esac
    if [ $? -ne 0 ]; then
        echo -e "\e[1;31mFailed to install $package\e[0m"
    fi
    echo -e "\e[1;33mInstalled $package\e[0m"
done
